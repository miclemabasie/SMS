{% extends "base.html" %}


{% block styletags %}
{% endblock styletags %}

{% block content %}

<div style="min-height: 88vh;" class="content container-fluid">

    <div class="page-header">
        <div class="row">
            <div class="col">
                <h3 class="page-title">Reporting Section</h3>
                <ul class="breadcrumb">
                    <li class="breadcrumb-item"><a href="index.html">Dashboard</a></li>
                    <li class="breadcrumb-item active">reports</li>
                </ul>
            </div>
        </div>
    </div>

    <div class="row">

        <div class="col-md-4 col-sm-6">
            <div class="ribbon-wrapper card">
                <div class="card-body">
                    <div class="ribbon ribbon-primary">Multiple Report Cards Generation</div>
                    <p>Generate Multiple Report Cards by clicking the button below..</p>
                </div>

                <div class="form-group mb-4 text-end float-right">
                    <div class="settings-btns">
                        <a href="" href="#" data-bs-toggle="modal" data-bs-target="#generate_report_card">
                            <button class="btn ribbon-primary text-white">Generate</button>
                        </a>
                    </div>
                </div>
            </div>
        </div>


        <div class="col-md-4 col-sm-6">
            <div class="ribbon-wrapper card">
                <div class="card-body">
                    <div class="ribbon ribbon-secondary">Single Report Card Generation</div>
                    <p>Generate single report card by clicking the button below.</p>
                </div>

                <div class="form-group mb-4 text-end float-right">
                    <div class="settings-btns">
                        <a href="" data-bs-toggle="modal" data-bs-target="#generate_single_report_card">
                            <button class="btn ribbon-secondary text-white">Generate</button>
                        </a>
                    </div>
                </div>
            </div>
        </div>


        <div class="col-md-4 col-sm-6">
            <div class="ribbon-wrapper card">
                <div class="card-body">
                    <div class="ribbon ribbon-success">Class Master Report</div>
                    <p>To generate class master Report, click the button below.</p>
                </div>

                <div class="form-group mb-4 text-end float-right">
                    <div class="settings-btns">
                        {% comment %} <a href=""  >
                            <button class="btn ribbon-secondary text-white">Generate</button>
                        </a> {% endcomment %}
                        <a href="" data-bs-toggle="modal" data-bs-target="#generate_classmaster_report">
                            <button class="btn ribbon-success text-white">Generate</button>
                        </a>
                    </div>
                </div>
            </div>
        </div>
{% comment %} 
        <a href="{% url 'reports:test-report' %}">Test generation</a>

        <button id="generate-pdf">Generate pdf</button> {% endcomment %}
    </div>
</div>

<!-- modal for selecting class for report card generation -->
<div class="modal custom-modal fade" id="generate_report_card" role="dialog">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body">
                                                                                                                                                
                <div class="card">
                    <div class="card-body">
                        <form action="{% url 'reports:generate_report_cards' %}" method="post">
                            {% csrf_token %}
                            <div class="row">
                                <div class="col-12">
                                    <div class="form-group local-forms">
                                        <label>Class <span class="login-danger">*</span></label>
                                        <select class="form-control" name="selected_class_id">

                                            {% for class in classes %}
                                            <option value="{{class.pkid}}">{{class.grade_level}}-{{class.class_name}}
                                            </option>
                                            {% endfor %}
                                        </select>
                                    </div>

                                    <div class="form-group local-forms">
                                        <label>Term <span class="login-danger">*</span></label>

                                        <select class="form-control" name="selected_term_id">

                                            {% for term in terms %}
                                            <option value="{{term.pkid}}">{{term}}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>


                                <div class="col-12 row">
                                    <div class="student-submit col-6">
                                        <button type="submit" class="btn btn-primary">Submit</button>
                                    </div>
                                    <div class="student-submit col-6 ml-5">
                                        <a href="" data-bs-dismiss="modal" class="btn btn-danger">Cancel</a>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<div class="modal custom-modal fade" id="generate_single_report_card" role="dialog">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body">
                <div class="form-header">
                    <h3>Generate Report Card</h3>
                    <p style="font-size: 17px;" class="badge bg-warning text-wrap text-white">Select the target class
                    </p>
                </div>
                <div class="card">
                    <div class="card-body">
                        <form action="{% url 'reports:generate_single_report_card' %}" method="post">
                            {% csrf_token %}
                            <div class="row">
                                <div class="col-12">
                                    <div class="form-group local-forms">
                                        <label>Class <span class="login-danger">*</span></label>
                                        <select class="form-control" name="selected_student_id">

                                            {% for student in students %}
                                            <option value="{{student.pkid}}">{{student.user.first_name}}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>


                                <div class="col-12 row">
                                    <div class="student-submit col-6">
                                        <button type="submit" class="btn btn-primary">Submit</button>
                                    </div>
                                    <div class="student-submit col-6 ml-5">
                                        <a href="" data-bs-dismiss="modal" class="btn btn-danger">Cancel</a>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% comment %} modal for class master report generationg {% endcomment %}
<div class="modal custom-modal fade" id="generate_classmaster_report" role="dialog">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body">
                <div class="form-header">
                    <h3>Generate Class Master Report</h3>
                    <p style="font-size: 17px;" class="badge bg-warning text-wrap text-white">Select the target class</p>
                </div>
                <div class="card">
                    <div class="card-body">
                        <form action="{% url 'reports:genereate_class_master_report' %}" method="post">
                            {% csrf_token %}
                            <div class="row">
                                <div class="col-12">
                                    <div class="form-group local-forms">
                                        <label>Class <span class="login-danger">*</span></label>
                                        <select class="form-control" name="selected_class_id">

                                            {% for class in classes %}
                                            <option value="{{class.pkid}}">{{class.grade_level}}-{{class.class_name}}</option>
                                            {% endfor %}
                                        </select>
                                    </div>

                                    <div class="form-group local-forms">
                                        <label>Term <span class="login-danger">*</span></label>

                                        <select class="form-control" name="selected_term_id">

                                            {% for term in terms %}
                                            <option value="{{term.pkid}}">{{term}}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>


                                <div class="col-12 row">
                                    <div class="student-submit col-6">
                                        <button type="submit" class="btn btn-primary">Submit</button>
                                    </div>
                                    <div class="student-submit col-6 ml-5">
                                        <a href="" data-bs-dismiss="modal" class="btn btn-danger">Cancel</a>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>




{% comment %} testing {% endcomment %}
<a href="url"></a>

{% endblock content %}



{% block scripttags %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.3.4/jspdf.min.js"></script>

<script>

    // Example function to fetch student data from Django API endpoint

    async function fetchStudentData() {
        let url = "{% url 'reports:gen' %}"
        console.log(url)
        try {
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error('Failed to fetch student data');
            }
            return await response.json();
        } catch (error) {
            console.error('Error fetching student data:', error);
            return [];
        }
    }

    // Example function to generate PDF report card for a student
    function generateStudentReportCard(student) {
        const doc = new jsPDF();

        // Add content to the PDF document based on the provided HTML template
        doc.setFontSize(12);

        // Header section
        doc.text(20, 20, 'Republic Of Cameroon\nPeace Work Fatherland');

        // Logo section
        // Example: Replace 'logo.png' with your actual logo path or use doc.addImage to add an image

        // School Name and Address section
        doc.text(160, 20, 'School Name\nSchool Address');

        // Report Title section
        doc.setFontSize(18);
        doc.text(20, 40, 'First Term Progress Report');

        // Student Information section
        doc.setFontSize(12);
        doc.text(20, 60, 'Section:');
        doc.text(20, 70, 'Specialty:');
        doc.text(20, 80, 'Student\'s Name:');
        doc.text(20, 90, 'Date of Birth:');

        doc.text(70, 60, student.section);
        doc.text(70, 70, student.specialty);
        doc.text(70, 80, student.name);
        doc.text(70, 90, student.date_of_birth);

        doc.text(120, 60, 'Academic Year:');
        doc.text(120, 70, 'Class:');
        doc.text(120, 80, 'Repeater:');
        doc.text(120, 90, 'Adm. Nr:');

        doc.text(180, 60, student.academic_year);
        doc.text(180, 70, student.class);
        doc.text(180, 80, "No");
        doc.text(180, 90, student.adm_nr);

        // Subjects table
        let startY = 110;
        doc.autoTable({
            startY: startY,
            head: [['SUBJECT NAME', '1st Seq', '2nd Seq', 'AV./20', 'COEF', 'M X C', 'Teacher\'s Name', 'Teacher\'s Remark', 'Teacher\'s Signature']],
            body: student.subjects.map(subject => [
                subject.name,
                subject.seq1,
                subject.seq2,
                subject.average,
                subject.coef,
                subject.mx_c,
                subject.teacher,
                subject.remark,
                subject.signature
            ]),
            theme: 'grid'
        });

        // Grand Total and other information section
        let grandTotalY = startY + student.subjects.length * 20 + 20; // Adjust spacing as needed
        doc.autoTable({
            startY: grandTotalY,
            body: [
                ['GRAND TOTAL:', student.grand_total.total, student.grand_total.coef, student.grand_total.mx_c, student.grand_total.remark],
                ['SEQ. Avg.', student.seq_avg.avg, student.seq_avg.term, student.seq_avg.class_avg, student.seq_avg.position]
            ],
            theme: 'grid',
            showHead: 'firstPage'
        });

        // Class Level and Total Enrollment section
        let classLevelY = grandTotalY + 40; // Adjust spacing as needed
        doc.autoTable({
            startY: classLevelY,
            body: [
                ['CLASS LEVEL', student.class_level],
                ['TOTAL ENROLLMENT:', student.total_enrollment]
            ],
            theme: 'grid',
            showHead: 'firstPage'
        });

        // Principal's Remarks section
        doc.setFontSize(12);
        doc.text(20, classLevelY + 40, 'Principal\'s Remarks');

        // Signatures section
        let signaturesY = classLevelY + 60; // Adjust spacing as needed
        doc.text(20, signaturesY, 'Signature of the class master');
        doc.text(100, signaturesY, 'Signature of the principal');

        return doc;
    }

    // Example function to merge multiple PDFs into a single document
    function mergePDFs(pdfs) {
        const mergedPDF = new jsPDF();
        pdfs.forEach((pdf, index) => {
            if (index !== 0) {
                mergedPDF.addPage();
            }
            mergedPDF.addPage(pdf);
        });
        return mergedPDF;
    }

    // Example usage to fetch data and proceed with PDF generation
    async function generateAndDownloadReports() {
        const students = await fetchStudentData();
        const pdfDocs = [];

        students.forEach(student => {
            const pdfDoc = generateStudentReportCard(student);
            pdfDocs.push(pdfDoc);
        });

        const mergedPDF = mergePDFs(pdfDocs);
        mergedPDF.save('all_student_reports.pdf');
    }

    // Call the function to start the process
    const genBtn = document.getElementById("generate-pdf")
    genBtn.addEventListener("click", () => {
        console.log("btn click")
        generateAndDownloadReports()
    })
</script>
{% endblock scripttags %}